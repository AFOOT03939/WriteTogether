@using System.Security.Claims
<!--
    TITULO: VISTA EDIT
    AUTOR: ADRIEL HERRERA

    DESCRIPCION: La estructura de la vista se basa en un contenedor principal
    (main_div_edit) que aloja todos los demás contenedores. Luego, este
    contenedor se divide en otros dos: header_edit (para el titulo) y
    body_edit (para el cuerpo en si de la historia).
-->

@{
    ViewData["Title"] = "Edit story";
}
@model WriteTogether.Models.DB.Story
@using System.Security.Claims;
@{
    var userName = User.Identity.IsAuthenticated
        ? User.FindFirst(ClaimTypes.Name)?.Value
        : null;

    string? userIdStr = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;

    int? userIdSafe = null;

    if (!string.IsNullOrEmpty(userIdStr) && int.TryParse(userIdStr, out var parsed))
    {
        userIdSafe = parsed;
    }
}




<html>
    <head>
        <link rel="stylesheet" href="~/css/Edit.css" />
    </head>
    <body>
        <!--ESTE DIV CONTIENE TODO LO DEMAS-->
    <input type="hidden" id="story_id" value="@(Model?.IdSt ?? 0)" />

        <div id="main_div_edit">
            <div id="header_edit"><!--DIV PARA EL TITULO DE LA HISTORIA-->
            @if(Model.AutorSt == userIdSafe  || Model.IdSt == 0)
            {
                <input id="title_edit" value="@(Model?.TitleSt ?? "")" />
            }
            else
            {
                <div id="title_edit">@Model.TitleSt</div>
            }
            

                <div id="header_options_edit">
                    <div id="editbar">Status: in progress</div>
                    <div id="head_stars" >
                        <div class="star2"></div>
                        <div class="star2"></div>
                        <div class="star2"></div>
                        <div class="star2"></div>
                        <div class="star2"></div>
                    </div>

                    @if(Model?.AutorSt == userIdSafe)
            {
                    <div class="editbarbut" id="savebut">Save</div>
                    <div class="editbarbut">Upload photo</div>
                    <div class="editbarbut" id="publicarbut">Publish</div>
            }
                </div>
            </div>

            <!--DIV PARA EL CUERPO DE LA PAGINA-->
            <div id="body_edit">

                <!--DIV PARA LA INFORMACION DE LA HISTORIA-->
                <div id="info_edit">
                <div id="info_text_edit">

                    <input type="hidden"
                           id="story_author_id"
                           value="@User.FindFirst(ClaimTypes.NameIdentifier)?.Value" />

                    <p>Author: @(Model?.AutorStNavigation?.NameUs ?? "You")</p>

                    <p>Collaborators:</p>
                    <ul>
                        @{
                            var creator = Model?.AutorStNavigation?.NameUs ?? "Unknown";

                            var authors = Model.Fragments
                            .Select(f => f.AutorFrNavigation?.NameUs)
                            .Where(name => !string.IsNullOrEmpty(name) && name != creator)
                            .Distinct()
                            .ToList();

                            if (authors.Count == 0)
                            {
                                <li>None</li>
                            }
                            else if (authors.Count == 1)
                            {
                                <li>@authors[0]</li>
                            }
                            else if (authors.Count == 2)
                            {
                                <li>@authors[0]</li>
                                <li>@authors[1]</li>
                            }
                            else
                            {
                                <li>@authors[0]</li>
                                <li>@authors[1]</li>
                                <li>and others</li>
                            }
                        }
                    </ul>


                </div>
                @{
                    string categoryName = Model?.CategorySt switch
                    {
                        1 => "Fantasy",
                        2 => "Romance",
                        3 => "Mystery",
                        4 => "Sci-Fi",
                        5 => "Horror",
                        6 => "Adventure",
                        7 => "Drama",
                        8 => "Comedy",
                        9 => "Historical",
                        10 => "Thriller",
                        _ => "Unknown"
                    };
                }
                @if (Model?.AutorSt == userIdSafe || Model.IdSt == 0)
                {
                    <div class="tagtitle">Category</div>
                    <select id="story_category_id" class="tu-clase-para-selects">
                        <option value="1">Fantasy</option>
                        <option value="2">Romance</option>
                        <option value="3">Mistery</option>
                        <option value="4">Scifi</option>
                        <option value="5">Horror</option>
                        <option value="6">Adventure</option>
                        <option value="7">Drama</option>
                        <option value="8">Comedy</option>
                        <option value="9">Historical</option>
                        <option value="10">Thriller</option>
                    </select>
                }
                else
                {
                    <div class="tagtitle">Category: @categoryName</div>
                }

                    <div id="info_tags_edit">
                        <div class="tagtitle">Tags</div>
                        <div id="info_tags_box">
                            <!--MOD 1
                            <div class="info_tags">Tag1<div class="xtag">x</div></div>
                            <div class="info_tags">Tag2<div class="xtag">x</div></div>
                            <div class="info_tags">Tag3<div class="xtag">x</div></div>
                        -->
                        </div>
                        <div class="tagtitle">Add new tag</div>
                    <div id="info_add_tags_edit"><div id="input_tag"><input type="text" placeholder="Type a tag..." id="add_tag" /><div class="xtag" style="font-size: 30px;" onclick="addTag()">+</div></div></div>
                        <div class="tagtitle">Story rating</div>
                        <div class="add_stars">
                            <div class="star"></div>
                            <div class="star"></div>
                            <div class="star"></div>
                            <div class="star"></div>
                            <div class="star"></div>
                        </div>
                    </div>
                    
                </div>

                <!--ESTE DIV ES EL ESPACIO DE EDICION DONDE SE ESCRIBE LA HISTORIA-->
                <div id="text_edit">
                    <div id="notebook_edit">
                    @if (Model?.Fragments != null && Model.Fragments.Any())
                    {
                        @foreach (var fragment in Model?.Fragments)
                        {
                            <div class="history_fragment">
                                <div class="frag_user">@fragment.AutorFrNavigation?.NameUs @fragment.DateUs</div>
                                <div class="frag_text">@fragment.ContentFr</div>
                            </div>
                        }
                    }
                    

                    </div>

                    <div id="type_edit">
                        <textarea id="input_story" placeholder="Type something..."></textarea>
                        <div id="buttons_ia_edit">
                        <div class="buttons_ia" @if (!User.Identity.IsAuthenticated)
                                {
                                    <text>onclick="alert('Debes iniciar sesión para agregar un fragmento.'); return false;"</text>
                            }
                                else
                            {
                                    <text>onclick="addFrag()"</text>
                            }
                        >
                            Submit
                        </div>
                            
                            <div class="buttons_ia">AI correction</div>
                            <div class="buttons_ia">Correct all story</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body>

</html>

<!--
    TITULO DE LA MODIFICACION: CONTENEDORES PARA LA EDICION DE LA HISTORIA (HTML)
    NUMERO DE MODIFICACION: 1
    AUTOR: ADRIEL HERRERA


    DESCRIPCION: Esta nueva actualizacion se va a centrar en crear las clases
    para la instancia de divs, como cuando alguien va a escribir una nueva parte
    de la historia o va agregar una nueva etiqueta.

    |
    |
    |
    |
    V

-->
<script>
    var currentUserName = "@userName";
</script>
<script src="~/js/Edit.js" asp-append-version="true"></script>
